{% extends 'dashboard/navbar_base.html' %}

{% block title %}Dashboard - Quantumix{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block extra_css %}
/* Dashboard-specific styles */
.container {
    max-width: 1400px;
    margin: 0 auto;
    background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
    border: 1px solid #333;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-header h1 {
    font-size: 2.8em;
    margin-bottom: 15px;
    color: #c0c0c0;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.page-header p {
    color: #888;
    font-size: 1.2em;
}

.error-message {
    background: linear-gradient(135deg, #cc0000, #ff3333);
    color: white;
    padding: 15px 25px;
    border-radius: 15px;
    margin-bottom: 30px;
    text-align: center;
    font-weight: bold;
    display: none;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.status-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.status-card {
    background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    border: 1px solid #444;
    transition: transform 0.3s ease;
}

.status-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.6);
}

.status-card h3 {
    color: #888;
    margin-bottom: 15px;
    font-size: 1.1em;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.status-card .value {
    font-size: 2.2em;
    font-weight: bold;
    color: #c0c0c0;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.control-panel {
    background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 40px;
    border: 1px solid #444;
}

.control-panel h2 {
    color: #c0c0c0;
    margin-bottom: 25px;
    font-size: 1.8em;
    text-align: center;
}

.control-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.control-btn {
    background: linear-gradient(135deg, #4a5568, #2d3748);
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 1em;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    min-width: 140px;
}

.control-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
}

.control-btn:active {
    transform: translateY(-1px);
}

.control-btn i {
    font-size: 1.2em;
}

.start-btn {
    background: linear-gradient(135deg, #00aa00, #00cc00);
    border: 3px solid #c0c0c0;
}

.start-btn:hover {
    background: linear-gradient(135deg, #00cc00, #00dd00);
    box-shadow: 0 8px 25px rgba(0, 170, 0, 0.5);
}

.calibrate-btn {
    background: linear-gradient(135deg, #4299e1, #3182ce);
}

.calibrate-btn:hover {
    background: linear-gradient(135deg, #63b3ed, #4299e1);
}

.emergency-btn-large {
    background: linear-gradient(135deg, #e53e3e, #c53030);
    border: 3px solid #c0c0c0;
    animation: pulse 2s infinite;
    box-shadow: 0 6px 20px rgba(229, 62, 62, 0.3);
}

.emergency-btn-large:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(229, 62, 62, 0.5);
}

.reset-btn {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
}

.reset-btn:hover {
    background: linear-gradient(135deg, #f6ad55, #ed8936);
}

.device-message {
    background: linear-gradient(135deg, #4a5568, #2d3748);
    padding: 20px;
    border-radius: 10px;
    margin-top: 20px;
    text-align: center;
    color: #c0c0c0;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
}

.chart-card {
    background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    border: 1px solid #444;
}

.chart-card h3 {
    color: #c0c0c0;
    margin-bottom: 20px;
    font-size: 1.4em;
    text-align: center;
}

.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 20px;
}

.fingers-section {
    background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 40px;
    border: 1px solid #444;
}

.fingers-section h2 {
    color: #c0c0c0;
    margin-bottom: 25px;
    font-size: 1.8em;
    text-align: center;
}

.fingers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.finger-card {
    background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    border: 2px solid #444;
    transition: all 0.3s ease;
}

.finger-card:hover {
    transform: translateY(-5px);
    border-color: #666;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
}

.finger-card h3 {
    color: #888;
    margin-bottom: 15px;
    font-size: 1em;
    text-transform: uppercase;
}

.finger-position {
    font-size: 1.8em;
    font-weight: bold;
    color: #c0c0c0;
    margin-bottom: 10px;
}

.finger-slider {
    width: 100%;
    margin: 15px 0;
    accent-color: #00cc00;
}

/* Responsive Design */
@media (max-width: 768px) {
    .charts-container {
        grid-template-columns: 1fr;
        gap: 25px;
    }

    .fingers-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .status-bar {
        flex-direction: column;
        gap: 15px;
    }

    .main-content {
        padding: 25px 15px;
    }

    .container {
        padding: 25px;
        border-radius: 15px;
    }

    .page-header h1 {
        font-size: 2.2em;
    }

    .control-btn {
        min-width: 110px;
        padding: 14px 18px;
        font-size: 0.9em;
    }
}
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>ü¶æ Bionic Hand Dashboard</h1>
        <p>Real-time monitoring and control system</p>
    </div>

    <div class="error-message" id="errorMessage">
        Connection error. Please check your network connection.
    </div>

    <div class="status-bar">
        <div class="status-card">
            <h3>Hand Status</h3>
            <div class="value" id="handStatus">Unknown</div>
        </div>
        <div class="status-card">
            <h3>EMG Signal</h3>
            <div class="value" id="emgSignal">0</div>
        </div>
        <div class="status-card">
            <h3>Temperature</h3>
            <div class="value" id="temperature">0¬∞C</div>
        </div>
        <div class="status-card">
            <h3>Grip Force</h3>
            <div class="value" id="gripForce">0%</div>
        </div>
    </div>

    <!-- Device Control Panel -->
    <div class="control-panel">
        <h2>üéÆ Device Control</h2>
        <div class="control-buttons">
            <button class="control-btn start-btn" onclick="toggleDevice()">
                <i class="fas fa-play"></i>
                <span id="btnText">Start</span>
            </button>
            <button class="control-btn calibrate-btn" onclick="calibrateDevice()">
                <i class="fas fa-cogs"></i>
                Calibrate
            </button>
            <button class="control-btn emergency-btn-large" onclick="emergencyStop()">
                <i class="fas fa-stop"></i>
                Emergency Stop
            </button>
            <button class="control-btn reset-btn" onclick="resetDevice()">
                <i class="fas fa-undo"></i>
                Reset
            </button>
            <button class="control-btn" onclick="testJS()"
                style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; font-weight: bold;">
                <i class="fas fa-bug"></i>
                Test JS
            </button>
        </div>
        <div id="deviceMessage" class="device-message" style="display: none;"></div>
    </div>

    <div class="charts-container">
        <div class="chart-card">
            <h3>üìä EMG Signal</h3>
            <div class="chart-container">
                <canvas id="emgChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üå°Ô∏è Temperature</h3>
            <div class="chart-container">
                <canvas id="tempChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üí™ Grip Force</h3>
            <div class="chart-container">
                <canvas id="gripChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üîã Battery Level</h3>
            <div class="chart-container">
                <canvas id="batteryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Finger Control Section -->
    <div class="fingers-section">
        <h2>‚úã Finger Control</h2>
        <div class="fingers-grid">
            <div class="finger-card">
                <h3>Thumb</h3>
                <div class="finger-position" id="thumbPosition">0¬∞</div>
                <input type="range" class="finger-slider" id="thumbSlider" min="0" max="180" value="0"
                    onchange="controlFinger('thumb', this.value)">
            </div>
            <div class="finger-card">
                <h3>Index</h3>
                <div class="finger-position" id="indexPosition">0¬∞</div>
                <input type="range" class="finger-slider" id="indexSlider" min="0" max="180" value="0"
                    onchange="controlFinger('index', this.value)">
            </div>
            <div class="finger-card">
                <h3>Middle</h3>
                <div class="finger-position" id="middlePosition">0¬∞</div>
                <input type="range" class="finger-slider" id="middleSlider" min="0" max="180" value="0"
                    onchange="controlFinger('middle', this.value)">
            </div>
            <div class="finger-card">
                <h3>Ring</h3>
                <div class="finger-position" id="ringPosition">0¬∞</div>
                <input type="range" class="finger-slider" id="ringSlider" min="0" max="180" value="0"
                    onchange="controlFinger('ring', this.value)">
            </div>
            <div class="finger-card">
                <h3>Pinky</h3>
                <div class="finger-position" id="pinkyPosition">0¬∞</div>
                <input type="range" class="finger-slider" id="pinkySlider" min="0" max="180" value="0"
                    onchange="controlFinger('pinky', this.value)">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
// Dashboard-specific JavaScript
let emgChart, tempChart, gripChart, batteryChart;
let isDeviceRunning = false;
let connectionStatus = 'disconnected';
let deviceData = {
    emg: [],
    temperature: [],
    gripForce: [],
    battery: []
};

// Initialize charts
function initCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                grid: { color: 'rgba(192, 192, 192, 0.1)' },
                ticks: { color: '#888' }
            },
            y: {
                grid: { color: 'rgba(192, 192, 192, 0.1)' },
                ticks: { color: '#888' }
            }
        },
        plugins: {
            legend: { labels: { color: '#c0c0c0' } }
        }
    };

    // EMG Chart
    emgChart = new Chart(document.getElementById('emgChart'), {
        type: 'line',
        data: {
            labels: Array.from({length: 50}, (_, i) => i),
            datasets: [{
                label: 'EMG Signal',
                data: deviceData.emg,
                borderColor: '#00cc00',
                backgroundColor: 'rgba(0, 204, 0, 0.1)',
                tension: 0.4
            }]
        },
        options: chartOptions
    });

    // Temperature Chart
    tempChart = new Chart(document.getElementById('tempChart'), {
        type: 'line',
        data: {
            labels: Array.from({length: 50}, (_, i) => i),
            datasets: [{
                label: 'Temperature (¬∞C)',
                data: deviceData.temperature,
                borderColor: '#ff6b6b',
                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                tension: 0.4
            }]
        },
        options: chartOptions
    });

    // Grip Force Chart
    gripChart = new Chart(document.getElementById('gripChart'), {
        type: 'line',
        data: {
            labels: Array.from({length: 50}, (_, i) => i),
            datasets: [{
                label: 'Grip Force (%)',
                data: deviceData.gripForce,
                borderColor: '#4ecdc4',
                backgroundColor: 'rgba(78, 205, 196, 0.1)',
                tension: 0.4
            }]
        },
        options: chartOptions
    });

    // Battery Chart
    batteryChart = new Chart(document.getElementById('batteryChart'), {
        type: 'doughnut',
        data: {
            labels: ['Used', 'Remaining'],
            datasets: [{
                data: [25, 75],
                backgroundColor: ['#ff6b6b', '#00cc00']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#c0c0c0' } }
            }
        }
    });
}

// Device control functions
function toggleDevice() {
    const btn = event.target.closest('.start-btn');
    const btnText = btn.querySelector('#btnText');
    
    if (isDeviceRunning) {
        stopDevice();
        btnText.textContent = 'Start';
        btn.querySelector('i').className = 'fas fa-play';
        showMessage('Device stopped successfully', 'success');
    } else {
        startDevice();
        btnText.textContent = 'Stop';
        btn.querySelector('i').className = 'fas fa-stop';
        showMessage('Device started successfully', 'success');
    }
    isDeviceRunning = !isDeviceRunning;
}

function startDevice() {
    updateConnectionStatus('connected');
    startDataSimulation();
    document.getElementById('handStatus').textContent = 'Active';
}

function stopDevice() {
    updateConnectionStatus('disconnected');
    stopDataSimulation();
    document.getElementById('handStatus').textContent = 'Inactive';
}

function calibrateDevice() {
    showMessage('Calibration started...', 'info');
    setTimeout(() => {
        showMessage('Calibration completed successfully!', 'success');
    }, 2000);
}

async function emergencyStop() {
    showMessage('EMERGENCY STOP ACTIVATED!', 'error');
    isDeviceRunning = false;
    stopDevice();
    
    const btn = document.querySelector('#btnText');
    if (btn) {
        btn.textContent = 'Start';
        document.querySelector('.start-btn i').className = 'fas fa-play';
    }

    // Reset all finger positions
    ['thumb', 'index', 'middle', 'ring', 'pinky'].forEach(finger => {
        const slider = document.getElementById(finger + 'Slider');
        const position = document.getElementById(finger + 'Position');
        if (slider && position) {
            slider.value = 0;
            position.textContent = '0¬∞';
        }
    });
}

function resetDevice() {
    showMessage('Resetting device...', 'info');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function testJS() {
    showMessage('JavaScript functionality test - All systems operational!', 'success');
}

// Finger control
function controlFinger(finger, angle) {
    document.getElementById(finger + 'Position').textContent = angle + '¬∞';
    if (connectionStatus === 'connected') {
        console.log(`Setting ${finger} to ${angle} degrees`);
    }
}

// Data simulation
let simulationInterval;

function startDataSimulation() {
    simulationInterval = setInterval(() => {
        // Generate random data
        const emgValue = Math.floor(Math.random() * 100);
        const tempValue = (36 + Math.random() * 2).toFixed(1);
        const gripValue = Math.floor(Math.random() * 100);

        // Update displays
        document.getElementById('emgSignal').textContent = emgValue;
        document.getElementById('temperature').textContent = tempValue + '¬∞C';
        document.getElementById('gripForce').textContent = gripValue + '%';

        // Update charts
        updateChartData(emgChart, emgValue);
        updateChartData(tempChart, parseFloat(tempValue));
        updateChartData(gripChart, gripValue);

    }, 1000);
}

function stopDataSimulation() {
    if (simulationInterval) {
        clearInterval(simulationInterval);
    }
}

function updateChartData(chart, newData) {
    if (chart.data.datasets[0].data.length >= 50) {
        chart.data.datasets[0].data.shift();
    }
    chart.data.datasets[0].data.push(newData);
    chart.update('none');
}

// Message display
function showMessage(message, type = 'info') {
    const messageElement = document.getElementById('deviceMessage');
    messageElement.textContent = message;
    messageElement.style.display = 'block';
    
    // Set color based on type
    switch(type) {
        case 'success':
            messageElement.style.background = 'linear-gradient(135deg, #00aa00, #00cc00)';
            break;
        case 'error':
            messageElement.style.background = 'linear-gradient(135deg, #cc0000, #ff3333)';
            break;
        case 'info':
            messageElement.style.background = 'linear-gradient(135deg, #4a5568, #2d3748)';
            break;
    }
    
    setTimeout(() => {
        messageElement.style.display = 'none';
    }, 3000);
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    updateConnectionStatus('disconnected');
});

// Error handling
window.addEventListener('error', function(e) {
    document.getElementById('errorMessage').style.display = 'block';
    console.error('JavaScript error:', e.error);
});

// Function to update connection status in navbar (inherited from base)
function updateConnectionStatus(status) {
    connectionStatus = status;
    
    // Call the base template's function if it exists
    if (typeof window.updateConnectionStatus === 'function') {
        window.updateConnectionStatus(status);
    }
    
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    
    if (statusIndicator && statusText) {
        statusIndicator.className = 'online-indicator';
        
        switch(status) {
            case 'connected':
                statusIndicator.classList.add('online');
                statusText.textContent = 'Connected';
                break;
            case 'disconnected':
                statusIndicator.classList.add('disconnected');
                statusText.textContent = 'Disconnected';
                break;
            case 'offline':
                statusIndicator.classList.add('offline');
                statusText.textContent = 'Offline';
                break;
        }
    }
}
{% endblock %}