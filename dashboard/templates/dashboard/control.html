{% extends 'dashboard/navbar_base.html' %}
{% load static %}

{% block title %}Device Control - Bionic Hand IoT Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Main Content */
    .main-content {
        padding: 30px 20px;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(45, 45, 45, 0.95);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(192, 192, 192, 0.1);
    }

    .page-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .page-header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        color: #c0c0c0;
    }

    .page-header p {
        color: #888;
        font-size: 1.1em;
    }

    .control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }

    .control-panel {
        background: linear-gradient(145deg, #2d2d2d 0%, #1a1a1a 100%);
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid rgba(192, 192, 192, 0.1);
    }

    .control-panel:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
    }

    .control-panel h3 {
        color: #c0c0c0;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .control-btn {
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .control-btn.primary {
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        color: white;
    }

    .control-btn.success {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
    }

    .control-btn.warning {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        color: white;
    }

    .control-btn.danger {
        background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        color: white;
    }

    .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .slider-container {
        margin: 20px 0;
    }

    .slider-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        color: #c0c0c0;
        font-weight: 500;
    }

    .slider {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: rgba(192, 192, 192, 0.3);
        outline: none;
        opacity: 0.8;
        transition: opacity 0.2s;
        cursor: pointer;
    }

    .slider:hover {
        opacity: 1;
    }

    .slider::-webkit-slider-thumb {
        appearance: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
    }

    .slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
    }

    .status-display {
        background: linear-gradient(145deg, rgba(74, 144, 226, 0.1) 0%, rgba(53, 122, 189, 0.05) 100%);
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #4a90e2;
        border: 1px solid rgba(74, 144, 226, 0.2);
    }

    .status-display h4 {
        color: #c0c0c0;
        margin-bottom: 5px;
    }

    .status-display p {
        color: #888;
        margin: 0;
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
        .main-content {
            padding: 20px 15px;
        }

        .container {
            padding: 20px;
        }

        .control-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .page-header h1 {
            font-size: 2em;
        }

        .control-btn {
            font-size: 1em;
            padding: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Main Content -->
<div class="main-content">
    <div class="container">
        <div class="page-header">
            <h1>üéõÔ∏è Device Control</h1>
            <p>Manual control and calibration settings</p>
        </div>

        <div class="control-grid">
            <!-- Basic Controls -->
            <div class="control-panel">
                <h3><i class="fas fa-hand-paper"></i> Basic Controls</h3>
                <button class="control-btn success" onclick="openHand()">
                    <i class="fas fa-hand-paper"></i>
                    Open Hand
                </button>
                <button class="control-btn warning" onclick="closeHand()">
                    <i class="fas fa-fist-raised"></i>
                    Close Hand
                </button>
                <button class="control-btn primary" onclick="relaxHand()">
                    <i class="fas fa-hand-peace"></i>
                    Relax Position
                </button>
                <button class="control-btn danger" onclick="emergencyStop()">
                    <i class="fas fa-stop"></i>
                    Emergency Stop
                </button>
            </div>

            <!-- Grip Force Control -->
            <div class="control-panel">
                <h3><i class="fas fa-compress-arrows-alt"></i> Grip Force</h3>
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Force Level</span>
                        <span id="gripValue">50%</span>
                    </div>
                    <input type="range" min="0" max="100" value="50" class="slider" id="gripSlider"
                        oninput="updateGripForce(this.value)">
                </div>
                <div class="status-display">
                    <h4>Current Grip Status</h4>
                    <p id="gripStatus">Moderate grip force applied</p>
                </div>
            </div>

            <!-- Individual Finger Control -->
            <div class="control-panel">
                <h3><i class="fas fa-hand-rock"></i> Finger Control</h3>
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Thumb</span>
                        <span id="thumbValue">0¬∞</span>
                    </div>
                    <input type="range" min="0" max="90" value="0" class="slider" id="thumbSlider"
                        oninput="updateFinger('thumb', this.value)">
                </div>
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Index</span>
                        <span id="indexValue">0¬∞</span>
                    </div>
                    <input type="range" min="0" max="90" value="0" class="slider" id="indexSlider"
                        oninput="updateFinger('index', this.value)">
                </div>
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Middle</span>
                        <span id="middleValue">0¬∞</span>
                    </div>
                    <input type="range" min="0" max="90" value="0" class="slider" id="middleSlider"
                        oninput="updateFinger('middle', this.value)">
                </div>
            </div>

            <!-- Calibration -->
            <div class="control-panel">
                <h3><i class="fas fa-cogs"></i> Calibration</h3>
                <button class="control-btn primary" onclick="startCalibration()">
                    <i class="fas fa-play"></i>
                    Start Calibration
                </button>
                <button class="control-btn warning" onclick="resetCalibration()">
                    <i class="fas fa-undo"></i>
                    Reset to Default
                </button>
                <button class="control-btn success" onclick="saveCalibration()">
                    <i class="fas fa-save"></i>
                    Save Settings
                </button>
                <div class="status-display">
                    <h4>Calibration Status</h4>
                    <p id="calibrationStatus">Last calibrated: 2025-09-24 10:30 AM</p>
                </div>
            </div>

            <!-- Power Management -->
            <div class="control-panel">
                <h3><i class="fas fa-battery-three-quarters"></i> Power Management</h3>
                <div class="status-display">
                    <h4>Battery Level</h4>
                    <p id="batteryLevel">87% - Charging</p>
                </div>
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Power Mode</span>
                        <span id="powerMode">Normal</span>
                    </div>
                    <input type="range" min="1" max="3" value="2" class="slider" id="powerSlider"
                        oninput="updatePowerMode(this.value)">
                    <div
                        style="display: flex; justify-content: space-between; font-size: 0.9em; color: #718096; margin-top: 5px;">
                        <span>Eco</span>
                        <span>Normal</span>
                        <span>High</span>
                    </div>
                </div>
                <button class="control-btn warning" onclick="enterSleepMode()">
                    <i class="fas fa-moon"></i>
                    Sleep Mode
                </button>
            </div>

            <!-- System Status -->
            <div class="control-panel">
                <h3><i class="fas fa-info-circle"></i> System Status</h3>
                <div class="status-display">
                    <h4>Connection</h4>
                    <p>‚úÖ Connected - Signal Strong</p>
                </div>
                <div class="status-display">
                    <h4>Temperature</h4>
                    <p id="systemTemp">36.5¬∞C - Normal</p>
                </div>
                <div class="status-display">
                    <h4>Last Activity</h4>
                    <p id="lastActivity">Active - 2 seconds ago</p>
                </div>
                <button class="control-btn primary" onclick="runDiagnostics()">
                    <i class="fas fa-stethoscope"></i>
                    Run Diagnostics
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    // Control functions
    function openHand() {
        console.log('Opening hand...');
        // Reset all finger sliders to 0
        ['thumbSlider', 'indexSlider', 'middleSlider'].forEach(id => {
            const slider = document.getElementById(id);
            slider.value = 0;
            updateFinger(id.replace('Slider', ''), 0);
        });
        alert('Hand opened!');
    }

    function closeHand() {
        console.log('Closing hand...');
        // Set all finger sliders to maximum
        ['thumbSlider', 'indexSlider', 'middleSlider'].forEach(id => {
            const slider = document.getElementById(id);
            slider.value = 90;
            updateFinger(id.replace('Slider', ''), 90);
        });
        alert('Hand closed!');
    }

    function relaxHand() {
        console.log('Relaxing hand...');
        // Set all sliders to mid position
        ['thumbSlider', 'indexSlider', 'middleSlider'].forEach(id => {
            const slider = document.getElementById(id);
            slider.value = 30;
            updateFinger(id.replace('Slider', ''), 30);
        });
        document.getElementById('gripSlider').value = 20;
        updateGripForce(20);
        alert('Hand relaxed!');
    }

    function updateGripForce(value) {
        document.getElementById('gripValue').textContent = value + '%';
        let status = 'Light grip force';
        if (value > 60) status = 'Strong grip force';
        else if (value > 30) status = 'Moderate grip force';
        document.getElementById('gripStatus').textContent = status + ' applied';
    }

    function updateFinger(finger, value) {
        document.getElementById(finger + 'Value').textContent = value + '¬∞';
        console.log(`${finger} finger set to ${value} degrees`);
    }

    function updatePowerMode(value) {
        const modes = ['', 'Eco', 'Normal', 'High'];
        document.getElementById('powerMode').textContent = modes[value];
    }

    function startCalibration() {
        alert('Start Calibration button clicked!'); // Test alert
        console.log('startCalibration function called');
        if (confirm('Start calibration process? This will take about 2 minutes.')) {
            console.log('User confirmed calibration');
            const statusElement = document.getElementById('calibrationStatus');
            if (statusElement) {
                statusElement.textContent = 'Calibration in progress...';
                console.log('Status updated to: Calibration in progress...');
                setTimeout(() => {
                    statusElement.textContent = 'Calibration completed successfully!';
                    console.log('Status updated to: Calibration completed successfully!');
                }, 3000);
            } else {
                console.error('calibrationStatus element not found');
            }
        } else {
            console.log('User cancelled calibration');
        }
    }

    function resetCalibration() {
        if (confirm('Reset all settings to factory defaults?')) {
            // Reset all sliders
            document.getElementById('gripSlider').value = 50;
            document.getElementById('powerSlider').value = 2;
            ['thumbSlider', 'indexSlider', 'middleSlider'].forEach(id => {
                document.getElementById(id).value = 0;
            });
            // Update displays
            updateGripForce(50);
            updatePowerMode(2);
            ['thumb', 'index', 'middle'].forEach(finger => updateFinger(finger, 0));
            alert('Settings reset to defaults!');
        }
    }

    function saveCalibration() {
        alert('Settings saved successfully!');
        document.getElementById('calibrationStatus').textContent = 'Last calibrated: ' + new Date().toLocaleString();
    }

    function enterSleepMode() {
        if (confirm('Enter sleep mode? Device will consume minimal power.')) {
            alert('Entering sleep mode...');
            document.querySelector('.status-indicator').innerHTML = '<div style="width: 12px; height: 12px; background: #ed8936; border-radius: 50%;"></div> Sleep Mode';
            document.querySelector('.status-indicator').style.background = '#ed8936';
        }
    }

    function runDiagnostics() {
        document.getElementById('lastActivity').textContent = 'Running diagnostics...';
        setTimeout(() => {
            alert('Diagnostics completed - All systems normal');
            document.getElementById('lastActivity').textContent = 'Diagnostics completed - All systems normal';
        }, 2000);
    }

    function emergencyStop() {
        if (confirm('Are you sure you want to emergency stop the bionic hand?')) {
            // Reset all controls
            document.getElementById('gripSlider').value = 0;
            ['thumbSlider', 'indexSlider', 'middleSlider'].forEach(id => {
                document.getElementById(id).value = 0;
            });
            updateGripForce(0);
            ['thumb', 'index', 'middle'].forEach(finger => updateFinger(finger, 0));

            alert('EMERGENCY STOP ACTIVATED!');
            document.querySelector('.status-indicator').innerHTML = '<div style="width: 12px; height: 12px; background: #e53e3e; border-radius: 50%;"></div> Emergency Stop';
            document.querySelector('.status-indicator').style.background = '#e53e3e';
        }
    }

    // Initialize values on page load
    window.onload = function () {
        updateGripForce(50);
        updatePowerMode(2);
        ['thumb', 'index', 'middle'].forEach(finger => updateFinger(finger, 0));
    };
{% endblock %}